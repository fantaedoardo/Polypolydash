<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <meta name="theme-color" content="#021024" />
  <title>POLYDASH</title>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#021024; font-family: "Arial Rounded MT Bold","Nunito","Trebuchet MS",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif; }
    canvas { width:100vw; height:100vh; display:block; touch-action: none; }
    /* Visible version badge even if JS crashes */
    #ver {
      position: fixed; left: 10px; top: 10px; z-index: 5;
      padding: 6px 10px; border-radius: 12px;
      background: rgba(0,0,0,0.28); color: rgba(255,255,255,0.85);
      font-weight: 800; font-size: 12px; letter-spacing: .5px;
      pointer-events:none;
    }
  </style>
</head>
<body>
<div id="ver">POLYDASH v3.3 SAFE</div>
<canvas id="c"></canvas>

<script>
/* Ultra-early error overlay */
(function(){
  window.onerror = function(msg, src, line, col){
    var d = document.createElement('div');
    d.style.cssText = "position:fixed;left:0;top:0;right:0;bottom:0;background:#000;color:#fff;padding:16px;z-index:9999;font-family:system-ui";
    d.innerHTML = "<div style='font-weight:900;font-size:18px'>Errore JS</div>"
      + "<div style='opacity:.9;margin-top:8px'>" + String(msg) + "</div>"
      + "<div style='opacity:.7;margin-top:8px'>Linea: " + line + ":" + col + "</div>";
    document.body.appendChild(d);
  };
})();
</script>

<script>
(function () {
  'use strict';

  var canvas = document.getElementById('c');
  var ctx = canvas.getContext('2d', { alpha:false });

  function resize() {
    var dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.width  = Math.floor(innerWidth  * dpr);
    canvas.height = Math.floor(innerHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener('resize', resize, { passive:true });
  resize();

  function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
  function rand(a,b){ return a + Math.random()*(b-a); }
  function lerp(a,b,t){ return a + (b-a)*t; }
  function smoothStep(t){ return t*t*(3-2*t); }

  // --- Rules ---
  var KM_PX = 1100;
  var POINTS_PER_KM = 100;

  var START_LIVES = 3;
  var BONUS_START_KM = 30;
  var BONUS_EVERY_KM = 10;
  var HIT_INV = 1.0;

  var GRAVITY = 1380;
  var HOLD_THRUST = 2550;
  var TAP_IMPULSE = -260;
  var HOLD_MAX_TIME = 0.22;
  var VY_UP_CAP = -540;
  var VY_DOWN_CAP = 820;

  var SPEED_0=240, SPEED_5=320, SPEED_10=395, SPEED_20=470, SPEED_30=545, SPEED_40=600;

  function gapAt(kmVal, H){
    var g0 = clamp(H*0.36, 220, 330);
    var g8 = clamp(H*0.31, 195, 290);
    var g16 = clamp(H*0.28, 175, 265);
    var g26 = clamp(H*0.25, 160, 245);
    var g36 = clamp(H*0.23, 148, 232);

    if (kmVal <= 8){
      return lerp(g0, g8, smoothStep(clamp(kmVal/8,0,1)));
    }
    if (kmVal <= 16){
      return lerp(g8, g16, smoothStep(clamp((kmVal-8)/8,0,1)));
    }
    if (kmVal <= 26){
      return lerp(g16, g26, smoothStep(clamp((kmVal-16)/10,0,1)));
    }
    return lerp(g26, g36, smoothStep(clamp((kmVal-26)/10,0,1)));
  }

  function spawnIntervalAt(kmVal){
    var s0=1.45, s8=1.10, s16=0.95, s26=0.86, s36=0.80;
    if (kmVal<=8)  return lerp(s0,s8, smoothStep(clamp(kmVal/8,0,1)));
    if (kmVal<=16) return lerp(s8,s16,smoothStep(clamp((kmVal-8)/8,0,1)));
    if (kmVal<=26) return lerp(s16,s26,smoothStep(clamp((kmVal-16)/10,0,1)));
    return lerp(s26,s36,smoothStep(clamp((kmVal-26)/10,0,1)));
  }

  function speedAt(kmVal){
    if (kmVal<=3)  return lerp(SPEED_0,SPEED_5, smoothStep(clamp(kmVal/3,0,1)));
    if (kmVal<=7)  return lerp(SPEED_5,SPEED_10,smoothStep(clamp((kmVal-3)/4,0,1)));
    if (kmVal<=15) return lerp(SPEED_10,SPEED_20,smoothStep(clamp((kmVal-7)/8,0,1)));
    if (kmVal<=25) return lerp(SPEED_20,SPEED_30,smoothStep(clamp((kmVal-15)/10,0,1)));
    return lerp(SPEED_30,SPEED_40,smoothStep(clamp((kmVal-25)/10,0,1)));
  }

  var SAFE_START_TIME = 1.10;

  var state = {
    started:false, over:false,
    t:0, dt:0, lastTs:0,
    speed:SPEED_0,
    spawnTimer:0,
    distancePx:0,
    kmCount:0,
    score:0,
    best: Number(localStorage.getItem('polydashBest') || 0),
    lives: START_LIVES,
    inv:0,
    holding:false,
    holdTime:0,
    shake:0
  };

  var octo = { x:0, y:0, vy:0, blink:0, phase:0 };
  var obstacles = [];
  var swimmers = [];
  var bubbles = [];

  function W(){ return innerWidth; }
  function H(){ return innerHeight; }
  function km(){ return state.distancePx / KM_PX; }

  function reset(){
    state.started=false; state.over=false;
    state.t=0; state.dt=0; state.lastTs=0;
    state.speed=SPEED_0;
    state.spawnTimer=0.65;
    state.distancePx=0;
    state.kmCount=0;
    state.score=0;
    state.lives=START_LIVES;
    state.inv=0;
    state.holding=false; state.holdTime=0;
    state.shake=0;

    obstacles.length=0; swimmers.length=0; bubbles.length=0;

    octo.x = Math.max(90, W()*0.26);
    octo.y = H()*0.52;
    octo.vy = 0;
    octo.blink = 0;
    octo.phase = 0;

    for (var i=0;i<10;i++) spawnFish(true);
  }

  function down(){
    if (state.over) return;
    if (!state.started) state.started = true;
    state.holding = true;
    state.holdTime = 0;
    octo.vy = Math.min(octo.vy, 140);
    octo.vy += TAP_IMPULSE;
    for (var i=0;i<5;i++) spawnBubble(octo.x-10, octo.y+8, rand(2,4));
  }
  function up(){ state.holding=false; state.holdTime=0; }

  function restartTap(x,y){
    if (!state.over) return false;
    var bw = Math.min(300, W()*0.72), bh=60;
    var bx = (W()-bw)/2, by = H()*0.66;
    return x>=bx && x<=bx+bw && y>=by && y<=by+bh;
  }

  function getXY(ev){
    var rect = canvas.getBoundingClientRect();
    var p = (ev.touches && ev.touches[0]) ? ev.touches[0] : ev;
    return { x:(p.clientX||0)-rect.left, y:(p.clientY||0)-rect.top };
  }

  canvas.addEventListener('pointerdown', function(ev){
    var xy = getXY(ev);
    if (restartTap(xy.x, xy.y)) { reset(); return; }
    down(); // SAFE: start anywhere (no play button dependency)
  }, { passive:true });

  canvas.addEventListener('pointerup', up, { passive:true });
  canvas.addEventListener('pointercancel', up, { passive:true });
  canvas.addEventListener('touchstart', function(e){ e.preventDefault(); }, { passive:false });

  addEventListener('keydown', function(e){
    if (e.code==='Space' || e.code==='ArrowUp'){ e.preventDefault(); if (state.over){ reset(); return; } down(); }
  });
  addEventListener('keyup', function(e){
    if (e.code==='Space' || e.code==='ArrowUp'){ e.preventDefault(); up(); }
  });

  function spawnObstacle(){
    var w = rand(64, 86);
    var kmVal = km();
    var gapH = gapAt(kmVal, H());
    var margin = Math.max(86, H()*0.16);
    var minY = margin;
    var maxY = H() - margin - gapH;
    var gapY = rand(minY, maxY);

    var hue = [350, 20, 170, 55][Math.floor(Math.random()*4)];
    obstacles.push({ x: W()+rand(90,150), gapY:gapY, gapH:gapH, w:w, seed:Math.random()*10, hue:hue, variant: (Math.random()<0.5?'branch':'fan') });
  }

  function spawnFish(initial){
    var y = rand(H()*0.16, H()*0.86);
    swimmers.push({ x: initial?rand(0,W()):W()+rand(40,240), y:y, s:rand(0.65,1.2), hue:rand(0,360), phase:Math.random()*10, speedK:rand(0.10,0.26), kind:(Math.random()<0.78?'fish':'special') });
  }

  function spawnBubble(x,y,r){
    bubbles.push({ x:x+rand(-6,6), y:y+rand(-6,6), r:r, vx:rand(-12,12), vy:rand(-70,-130), life:0, maxLife:rand(1.0,1.8) });
    if (bubbles.length>180) bubbles.splice(0, bubbles.length-180);
  }

  function circleRect(cx,cy,cr, rx,ry,rw,rh){
    var nx = clamp(cx, rx, rx+rw);
    var ny = clamp(cy, ry, ry+rh);
    var dx = cx-nx, dy = cy-ny;
    return dx*dx + dy*dy <= cr*cr;
  }

  function takeHit(){
    if (state.inv>0) return;
    state.lives -= 1;
    state.inv = HIT_INV;
    state.shake = 10;
    for (var i=0;i<12;i++) spawnBubble(octo.x, octo.y, rand(2,5));
    if (state.lives<=0){
      state.over = true;
      if (state.score>state.best){
        state.best = state.score;
        localStorage.setItem('polydashBest', String(state.best));
      }
    }
  }

  // --- Drawing ---
  function drawBackground(){
    var w=W(), h=H();
    var g = ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0, "#6ff7ff");
    g.addColorStop(0.25, "#52c8ff");
    g.addColorStop(0.55, "#2b7cff");
    g.addColorStop(1, "#0b1b42");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);
  }

  function drawCoralPillar(x, y, w, h, hue, seed, flip, variant){
    var sway = (Math.sin(seed*2.3) + Math.sin(seed*5.1)) * 2.0;
    ctx.save();
    if (flip){
      ctx.translate(0, y);
      ctx.scale(1, -1);
      y = 0;
    }

    ctx.shadowColor = "rgba(0,0,0,0.18)";
    ctx.shadowBlur = 18;
    ctx.shadowOffsetX = 8;
    ctx.shadowOffsetY = 2;

    var grad = ctx.createLinearGradient(x, y, x+w, y+h);
    grad.addColorStop(0, "hsla("+hue+",92%,64%,0.99)");
    grad.addColorStop(1, "hsla("+((hue+28)%360)+",92%,50%,0.99)");
    ctx.fillStyle = grad;

    var leftIn  = w*(0.10 + 0.02*Math.sin(seed*3.7));
    var rightIn = w*(0.10 + 0.02*Math.cos(seed*4.1));
    ctx.beginPath();
    ctx.moveTo(x+leftIn, y+h);
    ctx.lineTo(x+leftIn, y + h*0.26);
    ctx.bezierCurveTo(
      x + w*(0.10) + sway, y + h*0.06,
      x + w*(0.55) + sway*0.4, y + h*0.04,
      x + w - rightIn, y + h*0.24
    );
    ctx.lineTo(x + w - rightIn, y + h);
    ctx.closePath();
    ctx.fill();

    ctx.shadowColor = "rgba(0,0,0,0)";
    ctx.shadowBlur = 0;

    ctx.globalAlpha = 0.92;
    ctx.fillStyle = "hsla("+((hue+12)%360)+",92%,72%,0.92)";
    var arms = (variant==='fan') ? 6 : 4;
    for (var i=0;i<arms;i++){
      var ax = x + w*(0.18 + i*(0.64/(arms-1))) + Math.sin(seed+i)*2.2;
      var ay = y + h*((variant==='fan') ? 0.28 : 0.40) + i*3;
      var aw = w*(0.12 + 0.05*Math.sin(seed*1.7+i));
      var ah = h*(0.09 + 0.05*Math.cos(seed*2.1+i));
      ctx.beginPath();
      ctx.ellipse(ax, ay, aw, ah, (i%2?0.6:-0.6), 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    ctx.strokeStyle = "rgba(0,0,0,0.18)";
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.restore();
  }

  function drawObstacle(o){
    var topH = o.gapY;
    var botY = o.gapY + o.gapH;
    var botH = H() - botY;
    if (topH>10) drawCoralPillar(o.x, topH, o.w, topH, o.hue, o.seed, true, o.variant);
    if (botH>10) drawCoralPillar(o.x, botY, o.w, botH, o.hue, o.seed+1.7, false, o.variant);
  }

  function drawSwimmer(s){
    var bob = Math.sin(state.t*1.2 + s.phase) * 6;
    var x = s.x, y = s.y + bob, scale = s.s;
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(scale, scale);
    if (s.kind==='fish'){
      ctx.fillStyle = "hsla("+s.hue+",92%,62%,0.95)";
      ctx.beginPath(); ctx.ellipse(0,0,18,10,0,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = "hsla("+((s.hue+40)%360)+",92%,55%,0.95)";
      ctx.beginPath(); ctx.moveTo(-16,0); ctx.lineTo(-30,-10); ctx.lineTo(-30,10); ctx.closePath(); ctx.fill();
    } else {
      ctx.fillStyle = "hsla("+s.hue+",88%,64%,0.95)";
      ctx.beginPath(); ctx.ellipse(0,0,18,14,0,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();
  }

  function drawOcto(){
    octo.phase += state.dt * (state.holding ? 7.5 : 5.5);
    var vy = octo.vy;
    var stretch = clamp((-vy)/900, -0.22, 0.30);
    var squash  = clamp((vy)/1000, 0, 0.22);
    var sx = 1 + squash - stretch*0.25;
    var sy = 1 - squash + stretch;

    var t = state.t;
    var invFlash = (state.inv>0 && (Math.sin(t*24)>0)) ? 0.35 : 1.0;
    var hue = 185 + Math.sin(t*0.6)*18 + clamp(km()*2.2, 0, 90);

    ctx.save();
    ctx.translate(octo.x, octo.y);
    ctx.scale(sx, sy);
    ctx.globalAlpha = invFlash;

    ctx.fillStyle = "hsl("+hue+",86%,60%)";
    ctx.beginPath(); ctx.ellipse(0,0,22,18,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(0,-16,18,16,0,0,Math.PI*2); ctx.fill();

    ctx.strokeStyle = "hsla("+hue+",86%,56%,0.95)";
    ctx.lineWidth = 7;
    ctx.lineCap = "round";
    for (var i=0;i<5;i++){
      var a = -1.1 + i*0.55;
      var sway = Math.sin(octo.phase + i*1.1) * 6;
      var x0 = Math.cos(a)*8;
      var y0 = 10;
      var x1 = x0 + sway;
      var y1 = 30 + i*1.5;
      ctx.beginPath();
      ctx.moveTo(x0,y0);
      ctx.quadraticCurveTo(x1*0.6, y1*0.65, x1, y1);
      ctx.stroke();
    }

    ctx.globalAlpha = 1;
    ctx.restore();
  }

  function drawBubbles(){
    ctx.globalAlpha = 0.70;
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    for (var i=0;i<bubbles.length;i++){
      var b = bubbles[i];
      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }

  // roundRect polyfill
  if (!CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
      r=Math.min(r,w/2,h/2);
      this.beginPath();
      this.moveTo(x+r,y);
      this.arcTo(x+w,y,x+w,y+h,r);
      this.arcTo(x+w,y+h,x,y+h,r);
      this.arcTo(x,y+h,x,y,r);
      this.arcTo(x,y,x+w,y,r);
      this.closePath();
      return this;
    };
  }

  function drawHUD(){
    var pad=14, w=W(), h=H();
    var fontRound = '"Arial Rounded MT Bold","Nunito","Trebuchet MS",system-ui';
    // panel
    ctx.fillStyle = "rgba(0,0,0,0.22)";
    ctx.beginPath(); ctx.roundRect(pad,pad,260,78,18); ctx.fill();
    ctx.fillStyle="rgba(111,247,255,0.35)";
    ctx.beginPath(); ctx.roundRect(pad+10,pad+12,6,54,10); ctx.fill();

    ctx.fillStyle="rgba(111,247,255,0.95)";
    ctx.font="900 16px " + fontRound;
    ctx.fillText("POINTS", pad+26, pad+30);

    ctx.fillStyle="rgba(255,255,255,0.96)";
    ctx.font="950 28px " + fontRound;
    ctx.fillText(String(state.score), pad+26, pad+58);

    ctx.fillStyle="rgba(255,90,140,0.95)";
    ctx.font="950 18px " + fontRound;
    ctx.fillText("â¤".repeat(Math.max(0, Math.min(12, state.lives))), pad+26, pad+78);

    // start overlay
    if (!state.started && !state.over){
      ctx.globalAlpha = 0.35;
      ctx.fillStyle="#000";
      ctx.fillRect(0,0,w,h);
      ctx.globalAlpha = 1;
      ctx.fillStyle="rgba(255,255,255,0.95)";
      ctx.font="950 56px " + fontRound;
      ctx.textAlign="center";
      ctx.fillText("POLYDASH", w/2, h*0.32);
      ctx.textAlign="left";
    }

    if (state.over){
      ctx.fillStyle="rgba(0,0,0,0.45)";
      ctx.fillRect(0,0,w,h);
      ctx.textAlign="center";
      ctx.fillStyle="rgba(255,255,255,0.95)";
      ctx.font="950 64px " + fontRound;
      ctx.fillText("GAME OVER", w/2, h*0.32);
      ctx.fillStyle="rgba(111,247,255,0.95)";
      ctx.font="950 24px " + fontRound;
      ctx.fillText("POINTS", w/2, h*0.42);
      ctx.fillStyle="rgba(255,255,255,0.96)";
      ctx.font="950 44px " + fontRound;
      ctx.fillText(String(state.score), w/2, h*0.48);
      ctx.fillStyle="rgba(255,255,255,0.85)";
      ctx.font="900 20px " + fontRound;
      ctx.fillText("BEST " + String(state.best), w/2, h*0.54);

      var bw = Math.min(320, w*0.74), bh=64;
      var bx = (w-bw)/2, by=h*0.66;
      ctx.fillStyle="rgba(80,255,210,0.95)";
      ctx.beginPath(); ctx.roundRect(bx,by,bw,bh,22); ctx.fill();
      ctx.fillStyle="rgba(2,16,36,0.95)";
      ctx.font="950 24px " + fontRound;
      ctx.fillText("RESTART", w/2, by+bh/2+6);
      ctx.textAlign="left";
    }
  }

  function step(ts){
    if (!state.lastTs) state.lastTs = ts;
    state.dt = Math.min(0.033, (ts - state.lastTs)/1000);
    state.lastTs = ts;
    state.t += state.dt;

    if (state.inv>0) state.inv = Math.max(0, state.inv - state.dt);

    var kmVal = km();
    var targetSpeed = speedAt(kmVal);
    state.speed += (targetSpeed - state.speed) * (1 - Math.pow(0.001, state.dt));

    var spawnInterval = spawnIntervalAt(kmVal);

    if (state.started && !state.over){
      state.distancePx += state.speed * state.dt;

      var kmNow = Math.floor(state.distancePx / KM_PX);
      if (kmNow > state.kmCount){
        var delta = kmNow - state.kmCount;
        state.kmCount = kmNow;
        state.score += delta * POINTS_PER_KM;

        if (kmNow >= BONUS_START_KM && kmNow % BONUS_EVERY_KM === 0){
          state.lives += 1;
        }
      }

      state.spawnTimer -= state.dt;
      var okWarmup = state.t > SAFE_START_TIME;
      var last = obstacles[obstacles.length-1];
      var minGapX = Math.max(300, state.speed * 0.95);
      var okGap = (!last) || ((W() + 140) - last.x >= minGapX);
      if (okWarmup && state.spawnTimer <= 0 && okGap){
        spawnObstacle();
        state.spawnTimer = spawnInterval + rand(-0.10, 0.22);
      }

      var ay = GRAVITY;
      if (state.holding){
        state.holdTime += state.dt;
        if (state.holdTime <= HOLD_MAX_TIME){
          var k = clamp(0.85 + state.holdTime*1.2, 0.85, 1.20);
          ay = GRAVITY - HOLD_THRUST*k;
        } else {
          ay = GRAVITY;
        }
      } else {
        state.holdTime = 0;
      }

      octo.vy += ay * state.dt;
      octo.vy = clamp(octo.vy, VY_UP_CAP, VY_DOWN_CAP);
      octo.y += octo.vy * state.dt;

      var margin = 38;
      if (octo.y < margin){ octo.y = margin; octo.vy = 140; takeHit(); }
      if (octo.y > H()-margin){ octo.y = H()-margin; octo.vy = -200; takeHit(); }

      for (var i=obstacles.length-1; i>=0; i--){
        var o = obstacles[i];
        o.x -= state.speed * state.dt;
        if (o.x + o.w < -160) obstacles.splice(i,1);
      }

      for (var j=swimmers.length-1; j>=0; j--){
        var s = swimmers[j];
        s.x -= state.speed * s.speedK * state.dt;
        if (s.x < -260) swimmers.splice(j,1);
      }
      if (swimmers.filter(function(x){return x.kind==='fish';}).length < 10) spawnFish(false);

      for (var k2=bubbles.length-1; k2>=0; k2--){
        var b = bubbles[k2];
        b.life += state.dt;
        b.x += b.vx * state.dt;
        b.y += b.vy * state.dt;
        if (b.life > b.maxLife || b.y < -50) bubbles.splice(k2,1);
      }

      var cr = 18, cx = octo.x, cy = octo.y;
      for (var ii=0; ii<obstacles.length; ii++){
        var ob = obstacles[ii];
        var ox = ob.x, ow = ob.w;
        var topRect = {x: ox+8, y: 0, w: ow-16, h: ob.gapY-6};
        var botRect = {x: ox+8, y: ob.gapY + ob.gapH + 6, w: ow-16, h: H() - (ob.gapY + ob.gapH) - 6};
        if (circleRect(cx,cy,cr, topRect.x,topRect.y,topRect.w,topRect.h) ||
            circleRect(cx,cy,cr, botRect.x,botRect.y,botRect.w,botRect.h)){
          takeHit(); break;
        }
      }
    } else {
      octo.y = lerp(octo.y, H()*0.52, 1 - Math.pow(0.001, state.dt));
      octo.vy = 0;
    }

    // render
    drawBackground();
    for (var si=0; si<swimmers.length; si++) drawSwimmer(swimmers[si]);
    for (var oi=0; oi<obstacles.length; oi++) drawObstacle(obstacles[oi]);
    drawOcto();
    drawBubbles();
    drawHUD();

    requestAnimationFrame(step);
  }

  reset();
  requestAnimationFrame(step);
})();
</script>
</body>
</html>

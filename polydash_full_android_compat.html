<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <meta name="theme-color" content="#021024" />
  <title>POLYDASH</title>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#021024;
      font-family:"Arial Rounded MT Bold","Nunito","Trebuchet MS",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif; }
    canvas { width:100vw; height:100vh; display:block; touch-action:none; }
    #ver{position:fixed;left:10px;top:10px;z-index:6;padding:6px 10px;border-radius:12px;
      background:rgba(0,0,0,0.22);color:rgba(255,255,255,0.75);font-weight:900;font-size:12px;letter-spacing:.5px;pointer-events:none}
  </style>
</head>
<body>
<div id="ver">POLYDASH FULL v1 (Android compat)</div>
<canvas id="c"></canvas>

<script>
(function(){
  window.onerror = function(msg, src, line, col){
    try{
      var d = document.createElement('div');
      d.style.cssText="position:fixed;left:0;top:0;right:0;bottom:0;background:#000;color:#fff;padding:16px;z-index:9999;font-family:system-ui";
      d.innerHTML="<div style='font-weight:900;font-size:18px'>Errore JS</div>"
        +"<div style='opacity:.9;margin-top:8px'>"+String(msg)+"</div>"
        +"<div style='opacity:.7;margin-top:8px'>Linea: "+line+":"+col+"</div>";
      document.body.appendChild(d);
    }catch(e){}
  };
})();
</script>

<script>
(function(){
  'use strict';

  var canvas = document.getElementById('c');
  var ctx = canvas.getContext('2d', { alpha:false });

  function resize(){
    var dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.width = Math.floor(innerWidth * dpr);
    canvas.height = Math.floor(innerHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener('resize', resize, { passive:true });
  resize();

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function rand(a,b){ return a + Math.random()*(b-a); }
  function lerp(a,b,t){ return a + (b-a)*t; }
  function smoothStep(t){ return t*t*(3-2*t); }

  var KM_PX = 1100;
  var POINTS_PER_KM = 100;

  var START_LIVES = 3;
  var BONUS_START_KM = 30;
  var BONUS_EVERY_KM = 10;

  var HIT_INV = 1.0;

  var GRAVITY = 1380;
  var HOLD_THRUST = 2550;
  var TAP_IMPULSE = -260;
  var HOLD_MAX_TIME = 0.22;
  var VY_UP_CAP = -540;
  var VY_DOWN_CAP = 820;

  var SPEED_0=240, SPEED_5=320, SPEED_10=395, SPEED_20=470, SPEED_30=545, SPEED_40=600;

  function speedAt(kmVal){
    if (kmVal<=3)  return lerp(SPEED_0,SPEED_5, smoothStep(clamp(kmVal/3,0,1)));
    if (kmVal<=7)  return lerp(SPEED_5,SPEED_10,smoothStep(clamp((kmVal-3)/4,0,1)));
    if (kmVal<=15) return lerp(SPEED_10,SPEED_20,smoothStep(clamp((kmVal-7)/8,0,1)));
    if (kmVal<=25) return lerp(SPEED_20,SPEED_30,smoothStep(clamp((kmVal-15)/10,0,1)));
    return lerp(SPEED_30,SPEED_40,smoothStep(clamp((kmVal-25)/10,0,1)));
  }

  function gapAt(kmVal, H){
    var g0  = clamp(H*0.36, 220, 330);
    var g8  = clamp(H*0.31, 195, 290);
    var g16 = clamp(H*0.28, 175, 265);
    var g26 = clamp(H*0.25, 160, 245);
    var g36 = clamp(H*0.23, 148, 232);
    if (kmVal<=8)  return lerp(g0, g8,  smoothStep(clamp(kmVal/8,0,1)));
    if (kmVal<=16) return lerp(g8, g16, smoothStep(clamp((kmVal-8)/8,0,1)));
    if (kmVal<=26) return lerp(g16,g26, smoothStep(clamp((kmVal-16)/10,0,1)));
    return lerp(g26,g36, smoothStep(clamp((kmVal-26)/10,0,1)));
  }

  function spawnIntervalAt(kmVal){
    var s0=1.45, s8=1.10, s16=0.95, s26=0.86, s36=0.80;
    if (kmVal<=8)  return lerp(s0,s8,  smoothStep(clamp(kmVal/8,0,1)));
    if (kmVal<=16) return lerp(s8,s16, smoothStep(clamp((kmVal-8)/8,0,1)));
    if (kmVal<=26) return lerp(s16,s26, smoothStep(clamp((kmVal-16)/10,0,1)));
    return lerp(s26,s36, smoothStep(clamp((kmVal-26)/10,0,1)));
  }

  var SAFE_START_TIME = 1.05;

  var state = {
    started:false, over:false,
    t:0, dt:0, lastTs:0,
    speed:SPEED_0,
    spawnTimer:0.65,
    distancePx:0,
    kmCount:0,
    score:0,
    best: Number(localStorage.getItem('polydashBest') || 0),
    lives: START_LIVES,
    inv:0,
    holding:false,
    holdTime:0,
    shake:0,
    playBtn: { x:0, y:0, r:0 }
  };

  var octo = { x:0, y:0, vy:0, blink:0, phase:0 };
  var obstacles = [];
  var swimmers = [];
  var bubbles = [];

  var layers = [
    { x:0, speed:0.12, amp:14, alpha:0.22 },
    { x:0, speed:0.22, amp:20, alpha:0.18 },
    { x:0, speed:0.36, amp:26, alpha:0.14 }
  ];

  function W(){ return innerWidth; }
  function H(){ return innerHeight; }
  function km(){ return state.distancePx / KM_PX; }

  if (!CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
      r=Math.min(r,w/2,h/2);
      this.beginPath();
      this.moveTo(x+r,y);
      this.arcTo(x+w,y,x+w,y+h,r);
      this.arcTo(x+w,y+h,x,y+h,r);
      this.arcTo(x,y+h,x,y,r);
      this.arcTo(x,y,x+w,y,r);
      this.closePath();
      return this;
    };
  }

  function reset(){
    state.started=false; state.over=false;
    state.t=0; state.dt=0; state.lastTs=0;
    state.speed=SPEED_0;
    state.spawnTimer=0.65;
    state.distancePx=0;
    state.kmCount=0;
    state.score=0;
    state.lives=START_LIVES;
    state.inv=0;
    state.holding=false; state.holdTime=0;
    state.shake=0;

    obstacles.length=0; swimmers.length=0; bubbles.length=0;

    octo.x = Math.max(90, W()*0.26);
    octo.y = H()*0.52;
    octo.vy = 0;
    octo.blink = 0;
    octo.phase = 0;

    state.playBtn.x = W()/2;
    state.playBtn.y = H()*0.36 + 140;
    state.playBtn.r = Math.max(38, Math.min(60, W()*0.07));

    for (var i=0;i<10;i++) spawnFish(true);
  }

  function takeHit(){
    if (state.inv>0) return;
    state.lives -= 1;
    state.inv = HIT_INV;
    state.shake = 10;
    for (var i=0;i<12;i++) spawnBubble(octo.x, octo.y, rand(2,5));
    if (state.lives<=0){
      state.over = true;
      if (state.score>state.best){
        state.best = state.score;
        localStorage.setItem('polydashBest', String(state.best));
      }
    }
  }

  function down(){
    if (state.over) return;
    if (!state.started) state.started = true;
    state.holding = true;
    state.holdTime = 0;
    octo.vy = Math.min(octo.vy, 140);
    octo.vy += TAP_IMPULSE;
    for (var i=0;i<5;i++) spawnBubble(octo.x-10, octo.y+8, rand(2,4));
  }
  function up(){ state.holding=false; state.holdTime=0; }

  function restartTap(x,y){
    if (!state.over) return false;
    var bw = Math.min(320, W()*0.74), bh=64;
    var bx = (W()-bw)/2, by = H()*0.66;
    return x>=bx && x<=bx+bw && y>=by && y<=by+bh;
  }

  function getXY(ev){
    var rect = canvas.getBoundingClientRect();
    var p = (ev.touches && ev.touches[0]) ? ev.touches[0] : ev;
    return { x:(p.clientX||0)-rect.left, y:(p.clientY||0)-rect.top };
  }

  function inPlayBubble(x,y){
    var dx = x - state.playBtn.x;
    var dy = y - state.playBtn.y;
    return dx*dx + dy*dy <= state.playBtn.r*state.playBtn.r;
  }

  canvas.addEventListener('pointerdown', function(ev){
    var xy = getXY(ev);
    if (restartTap(xy.x, xy.y)) { reset(); return; }

    if (!state.started && !state.over){
      if (inPlayBubble(xy.x, xy.y)){
        down();
      }
      return;
    }
    down();
  }, { passive:true });

  canvas.addEventListener('pointerup', up, { passive:true });
  canvas.addEventListener('pointercancel', up, { passive:true });
  canvas.addEventListener('touchstart', function(e){ e.preventDefault(); }, { passive:false });

  addEventListener('keydown', function(e){
    if (e.code==='Space' || e.code==='ArrowUp'){ e.preventDefault(); if (state.over){ reset(); return; } down(); }
  });
  addEventListener('keyup', function(e){
    if (e.code==='Space' || e.code==='ArrowUp'){ e.preventDefault(); up(); }
  });

  function spawnObstacle(){
    var w = rand(64, 86);
    var kmVal = km();
    var gapH = gapAt(kmVal, H());
    var margin = Math.max(86, H()*0.16);
    var minY = margin;
    var maxY = H() - margin - gapH;
    var gapY = rand(minY, maxY);
    var hues = [350, 20, 170, 55];
    var hue = hues[Math.floor(Math.random()*4)];
    obstacles.push({ x: W()+rand(90,150), gapY:gapY, gapH:gapH, w:w, seed:Math.random()*10, hue:hue, variant:(Math.random()<0.5?'branch':'fan') });
  }

  function spawnFish(initial){
    var y = rand(H()*0.16, H()*0.86);
    swimmers.push({ x: initial?rand(0,W()):W()+rand(40,240), y:y, s:rand(0.65,1.2), hue:rand(0,360), phase:Math.random()*10, speedK:rand(0.10,0.26), kind:(Math.random()<0.78?'fish':'special') });
  }

  function spawnBubble(x,y,r){
    bubbles.push({ x:x+rand(-6,6), y:y+rand(-6,6), r:r, vx:rand(-12,12), vy:rand(-70,-130), life:0, maxLife:rand(1.0,1.8) });
    if (bubbles.length>180) bubbles.splice(0, bubbles.length-180);
  }

  function circleRect(cx,cy,cr, rx,ry,rw,rh){
    var nx = clamp(cx, rx, rx+rw);
    var ny = clamp(cy, ry, ry+rh);
    var dx = cx-nx, dy = cy-ny;
    return dx*dx + dy*dy <= cr*cr;
  }

  function drawBackground(){
    var w=W(), h=H();
    var g = ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0, "#6ff7ff");
    g.addColorStop(0.25, "#52c8ff");
    g.addColorStop(0.55, "#2b7cff");
    g.addColorStop(1, "#0b1b42");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    ctx.globalAlpha = 0.20;
    for (var i=0;i<5;i++){
      var yy = h*(0.18 + i*0.12) + Math.sin(state.t*0.6 + i)*14;
      var gg = ctx.createLinearGradient(0, yy, w, yy);
      gg.addColorStop(0, "rgba(255,255,255,0)");
      gg.addColorStop(0.5, "rgba(255,255,255,1)");
      gg.addColorStop(1, "rgba(255,255,255,0)");
      ctx.fillStyle = gg;
      ctx.beginPath();
      ctx.ellipse(w/2 + Math.sin(state.t*0.35+i)*90, yy, w*0.62, 26, 0, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    for (var li=0; li<layers.length; li++){
      var L = layers[li];
      L.x -= state.speed * L.speed * state.dt;
      if (L.x < -w) L.x += w;

      ctx.globalAlpha = L.alpha;
      ctx.fillStyle = (li===0) ? "#0d3a66" : (li===1) ? "#0a2f57" : "#072449";
      var baseY = h*0.96;
      for (var rep=-1; rep<=1; rep++){
        var ox = L.x + rep*w;
        ctx.beginPath();
        ctx.moveTo(ox, h);
        for (var x=0; x<=w; x+=56){
          var y = baseY - (120 + li*60) + Math.sin((x*0.010) + state.t*0.55 + li)*L.amp;
          ctx.quadraticCurveTo(ox+x+28, y-20, ox+x+56, y);
        }
        ctx.lineTo(ox+w, h);
        ctx.closePath();
        ctx.fill();
      }
      ctx.globalAlpha = 1;
    }
  }

  function drawCoralPillar(x, y, w, h, hue, seed, flip, variant){
    var sway = (Math.sin(seed*2.3) + Math.sin(seed*5.1)) * 2.0;
    ctx.save();
    if (flip){
      ctx.translate(0, y);
      ctx.scale(1, -1);
      y = 0;
    }

    ctx.shadowColor = "rgba(0,0,0,0.18)";
    ctx.shadowBlur = 18;
    ctx.shadowOffsetX = 8;
    ctx.shadowOffsetY = 2;

    var grad = ctx.createLinearGradient(x, y, x+w, y+h);
    grad.addColorStop(0, "hsla("+hue+",92%,64%,0.99)");
    grad.addColorStop(1, "hsla("+((hue+28)%360)+",92%,50%,0.99)");
    ctx.fillStyle = grad;

    var leftIn  = w*(0.10 + 0.02*Math.sin(seed*3.7));
    var rightIn = w*(0.10 + 0.02*Math.cos(seed*4.1));
    ctx.beginPath();
    ctx.moveTo(x+leftIn, y+h);
    ctx.lineTo(x+leftIn, y + h*0.26);
    ctx.bezierCurveTo(
      x + w*0.10 + sway, y + h*0.06,
      x + w*0.55 + sway*0.4, y + h*0.04,
      x + w - rightIn, y + h*0.24
    );
    ctx.lineTo(x + w - rightIn, y + h);
    ctx.closePath();
    ctx.fill();

    ctx.shadowColor = "rgba(0,0,0,0)";
    ctx.shadowBlur = 0;

    ctx.globalAlpha = 0.92;
    ctx.fillStyle = "hsla("+((hue+12)%360)+",92%,72%,0.92)";
    var arms = (variant==='fan') ? 6 : 4;
    for (var i=0;i<arms;i++){
      var ax = x + w*(0.18 + i*(0.64/(arms-1))) + Math.sin(seed+i)*2.2;
      var ay = y + h*((variant==='fan') ? 0.28 : 0.40) + i*3;
      var aw = w*(0.12 + 0.05*Math.sin(seed*1.7+i));
      var ah = h*(0.09 + 0.05*Math.cos(seed*2.1+i));
      ctx.beginPath();
      ctx.ellipse(ax, ay, aw, ah, (i%2?0.6:-0.6), 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    ctx.strokeStyle = "rgba(0,0,0,0.18)";
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.restore();
  }

  function drawObstacle(o){
    var topH = o.gapY;
    var botY = o.gapY + o.gapH;
    var botH = H() - botY;
    if (topH>10) drawCoralPillar(o.x, topH, o.w, topH, o.hue, o.seed, true, o.variant);
    if (botH>10) drawCoralPillar(o.x, botY, o.w, botH, o.hue, o.seed+1.7, false, o.variant);
  }

  function drawSwimmer(s){
    var bob = Math.sin(state.t*1.2 + s.phase) * 6;
    var x = s.x, y = s.y + bob, scale = s.s;
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(scale, scale);
    if (s.kind==='fish'){
      ctx.fillStyle = "hsla("+s.hue+",92%,62%,0.95)";
      ctx.beginPath(); ctx.ellipse(0,0,18,10,0,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = "hsla("+((s.hue+40)%360)+",92%,55%,0.95)";
      ctx.beginPath(); ctx.moveTo(-16,0); ctx.lineTo(-30,-10); ctx.lineTo(-30,10); ctx.closePath(); ctx.fill();
      ctx.fillStyle = "#0a1c2d";
      ctx.beginPath(); ctx.arc(8,-2,2.2,0,Math.PI*2); ctx.fill();
    } else {
      ctx.fillStyle = "hsla("+s.hue+",88%,64%,0.95)";
      ctx.beginPath(); ctx.ellipse(0,0,18,14,0,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();
  }

  function drawOcto(){
    octo.phase += state.dt * (state.holding ? 7.5 : 5.5);

    var vy = octo.vy;
    var stretch = clamp((-vy)/900, -0.22, 0.30);
    var squash  = clamp((vy)/1000, 0, 0.22);
    var sx = 1 + squash - stretch*0.25;
    var sy = 1 - squash + stretch;

    var t = state.t;
    var invFlash = (state.inv>0 && (Math.sin(t*24)>0)) ? 0.35 : 1.0;
    var hue = 185 + Math.sin(t*0.6)*18 + clamp(km()*2.2, 0, 90);

    ctx.save();
    ctx.translate(octo.x, octo.y);
    ctx.scale(sx, sy);
    ctx.globalAlpha = invFlash;

    ctx.fillStyle = "hsl("+hue+",86%,60%)";
    ctx.beginPath(); ctx.ellipse(0,0,22,18,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(0,-16,18,16,0,0,Math.PI*2); ctx.fill();

    ctx.strokeStyle = "hsla("+hue+",86%,56%,0.95)";
    ctx.lineWidth = 7;
    ctx.lineCap = "round";
    for (var i=0;i<5;i++){
      var a = -1.1 + i*0.55;
      var sway = Math.sin(octo.phase + i*1.1) * 6;
      var x0 = Math.cos(a)*8;
      var y0 = 10;
      var x1 = x0 + sway;
      var y1 = 30 + i*1.5;
      ctx.beginPath();
      ctx.moveTo(x0,y0);
      ctx.quadraticCurveTo(x1*0.6, y1*0.65, x1, y1);
      ctx.stroke();
    }

    octo.blink -= state.dt;
    if (octo.blink<=0 && Math.random()<0.012) octo.blink = 0.11;
    ctx.globalAlpha = invFlash;
    if (octo.blink>0){
      ctx.strokeStyle = "#062033";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(-10,-18); ctx.lineTo(-4,-18);
      ctx.moveTo(4,-18);  ctx.lineTo(10,-18);
      ctx.stroke();
    } else {
      ctx.fillStyle = "#062033";
      ctx.beginPath(); ctx.arc(-7,-18,3.2,0,Math.PI*2); ctx.arc(7,-18,3.2,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = "rgba(255,255,255,0.7)";
      ctx.beginPath(); ctx.arc(-6,-19,1.1,0,Math.PI*2); ctx.arc(8,-19,1.1,0,Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha = 1;

    ctx.restore();
  }

  function drawBubbles(){
    ctx.globalAlpha = 0.70;
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    for (var i=0;i<bubbles.length;i++){
      var b = bubbles[i];
      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }

  function drawCurvedLogo(text, cx, cy, radius, scale){
    var fontLogo = '"Arial Rounded MT Bold","Comic Sans MS","Trebuchet MS",system-ui';
    ctx.save();
    ctx.translate(cx, cy);
    ctx.scale(scale, scale);

    var fontSize = 96;
    ctx.font = "950 "+fontSize+"px "+fontLogo;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    var widths = [];
    var total = 0;
    for (var i=0;i<text.length;i++){
      var w = ctx.measureText(text[i]).width;
      widths.push(w);
      total += w;
    }
    var angSpan = clamp(total/650, 0.95, 1.35);
    var startAng = -angSpan/2;

    function strokePass(dx, dy, lw, color, alpha){
      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.lineWidth = lw;
      ctx.strokeStyle = color;
      var acc = 0;
      for (var i=0;i<text.length;i++){
        var ch = text[i];
        var wch = widths[i];
        var mid = acc + wch/2;
        var tt = mid/total;
        var ang = startAng + tt*angSpan;
        var x = Math.sin(ang)*radius + dx;
        var y = -Math.cos(ang)*radius + dy;
        ctx.save();
        ctx.translate(x,y);
        ctx.rotate(ang);
        ctx.strokeText(ch, 0, 0);
        ctx.restore();
        acc += wch;
      }
      ctx.restore();
    }

    strokePass(10,18,22,"rgba(0,0,0,0.55)",0.26);
    strokePass(0,0,22,"rgba(0,0,0,0.55)",1);
    strokePass(0,0,15,"rgba(255,255,255,0.97)",1);

    var g = ctx.createLinearGradient(-260,-80,260,80);
    g.addColorStop(0.00,"#28d6ff");
    g.addColorStop(0.30,"#7dff6a");
    g.addColorStop(0.55,"#ffe85a");
    g.addColorStop(0.78,"#ff6aa2");
    g.addColorStop(1.00,"#9b6bff");
    ctx.fillStyle = g;

    var acc2 = 0;
    for (var i2=0;i2<text.length;i2++){
      var ch2 = text[i2];
      var wch2 = widths[i2];
      var mid2 = acc2 + wch2/2;
      var tt2 = mid2/total;
      var ang2 = startAng + tt2*angSpan;
      var x2 = Math.sin(ang2)*radius;
      var y2 = -Math.cos(ang2)*radius;
      ctx.save();
      ctx.translate(x2,y2);
      ctx.rotate(ang2);
      ctx.fillText(ch2, 0, 0);
      ctx.restore();
      acc2 += wch2;
    }

    ctx.globalAlpha = 0.18;
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.ellipse(0, -radius-22, 240, 18, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;

    ctx.restore();
  }

  function drawRoundedPlayTriangle(cx, cy, size){
    var s = size;
    var r = s*0.22;
    var p1x = cx - s*0.22, p1y = cy - s*0.32;
    var p2x = cx - s*0.22, p2y = cy + s*0.32;
    var p3x = cx + s*0.38, p3y = cy;

    ctx.beginPath();
    ctx.moveTo(p1x + r, p1y + r*0.2);
    ctx.quadraticCurveTo(p1x, p1y, p1x + r*0.6, p1y + r);
    ctx.quadraticCurveTo((p1x+p3x)/2, (p1y+p3y)/2, p3x - r, p3y - r*0.2);
    ctx.quadraticCurveTo(p3x, p3y, p3x - r, p3y + r*0.2);
    ctx.quadraticCurveTo((p3x+p2x)/2, (p3y+p2y)/2, p2x + r*0.6, p2y - r);
    ctx.quadraticCurveTo(p2x, p2y, p2x + r, p2y - r*0.2);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
  }

  function drawPlayBubble(cx, cy, r){
    state.playBtn.x = cx; state.playBtn.y = cy; state.playBtn.r = r;

    ctx.globalAlpha = 0.18;
    var glow = ctx.createRadialGradient(cx, cy, r*0.3, cx, cy, r*1.4);
    glow.addColorStop(0, "rgba(255,235,160,0.55)");
    glow.addColorStop(0.6, "rgba(120,255,210,0.28)");
    glow.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = glow;
    ctx.beginPath(); ctx.arc(cx,cy,r*1.35,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;

    var g = ctx.createRadialGradient(cx-r*0.28, cy-r*0.35, r*0.2, cx, cy, r);
    g.addColorStop(0, "rgba(255,255,255,0.88)");
    g.addColorStop(0.35, "rgba(170,250,255,0.58)");
    g.addColorStop(1, "rgba(60,170,255,0.38)");
    ctx.fillStyle = g;
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();

    ctx.strokeStyle = "rgba(255,255,255,0.78)";
    ctx.lineWidth = 4;
    ctx.stroke();

    ctx.globalAlpha = 0.48;
    ctx.fillStyle = "rgba(255,255,255,0.95)";
    ctx.beginPath();
    ctx.ellipse(cx - r*0.25, cy - r*0.25, r*0.30, r*0.18, -0.4, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;

    var pg = ctx.createLinearGradient(cx-r*0.2, cy-r*0.4, cx+r*0.5, cy+r*0.4);
    pg.addColorStop(0, "#7dff6a");
    pg.addColorStop(0.55, "#ffe85a");
    pg.addColorStop(1, "#ff6aa2");
    ctx.fillStyle = pg;
    ctx.strokeStyle = "rgba(0,0,0,0.18)";
    ctx.lineWidth = 3;
    drawRoundedPlayTriangle(cx, cy, r*0.95);
  }

  function drawHUD(){
    var pad=14, w=W(), h=H();
    var fontUI = '"Arial Rounded MT Bold","Nunito","Trebuchet MS",system-ui';

    ctx.fillStyle="rgba(0,0,0,0.22)";
    ctx.beginPath(); ctx.roundRect(pad,pad,260,78,18); ctx.fill();
    ctx.fillStyle="rgba(111,247,255,0.35)";
    ctx.beginPath(); ctx.roundRect(pad+10,pad+12,6,54,10); ctx.fill();

    ctx.fillStyle="rgba(111,247,255,0.95)";
    ctx.font="900 16px "+fontUI;
    ctx.fillText("POINTS", pad+26, pad+30);

    ctx.fillStyle="rgba(255,255,255,0.96)";
    ctx.font="950 28px "+fontUI;
    ctx.fillText(String(state.score), pad+26, pad+58);

    ctx.fillStyle="rgba(255,90,140,0.95)";
    ctx.font="950 18px "+fontUI;
    var hearts = "";
    var hn = Math.max(0, Math.min(12, state.lives));
    for (var i=0;i<hn;i++) hearts += "â¤";
    ctx.fillText(hearts, pad+26, pad+78);

    ctx.textAlign="right";
    ctx.fillStyle="rgba(255,255,255,0.75)";
    ctx.font="900 14px "+fontUI;
    ctx.fillText("BEST "+String(state.best), w-pad, pad+22);
    ctx.fillStyle="rgba(255,255,255,0.60)";
    ctx.font="800 12px "+fontUI;
    ctx.fillText(km().toFixed(2)+" km", w-pad, pad+40);
    ctx.textAlign="left";

    if (!state.started && !state.over){
      ctx.globalAlpha = 0.30;
      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,w,h);
      ctx.globalAlpha = 1;

      ctx.globalAlpha = 0.16;
      ctx.fillStyle = "#fff";
      for (var i2=0;i2<3;i2++){
        ctx.beginPath();
        ctx.ellipse(w*(0.25+i2*0.25), h*0.22, w*0.22, h*0.55, 0.2, 0, Math.PI*2);
        ctx.fill();
      }
      ctx.globalAlpha = 1;

      var logoScale = Math.min(1.10, Math.max(0.86, w/880));
      drawCurvedLogo("POLYDASH", w/2, h*0.36, 120, logoScale);

      var r = Math.max(38, Math.min(60, w*0.07));
      drawPlayBubble(w/2, h*0.36 + 140, r);
    } else {
      state.playBtn.r = 0;
    }

    if (state.over){
      ctx.fillStyle="rgba(0,0,0,0.45)";
      ctx.fillRect(0,0,w,h);

      var fontLogo = '"Arial Rounded MT Bold","Comic Sans MS","Trebuchet MS",system-ui';
      ctx.textAlign="center";
      ctx.textBaseline="middle";
      ctx.font="950 68px "+fontLogo;

      ctx.lineWidth = 20;
      ctx.strokeStyle = "rgba(0,0,0,0.55)";
      ctx.strokeText("GAME OVER", w/2, h*0.32 + 16);
      ctx.lineWidth = 14;
      ctx.strokeStyle = "rgba(255,255,255,0.97)";
      ctx.strokeText("GAME OVER", w/2, h*0.32);

      var gg2 = ctx.createLinearGradient(w*0.25, h*0.30, w*0.75, h*0.38);
      gg2.addColorStop(0, "#28d6ff");
      gg2.addColorStop(0.35, "#7dff6a");
      gg2.addColorStop(0.7, "#ffe85a");
      gg2.addColorStop(1, "#ff6aa2");
      ctx.fillStyle = gg2;
      ctx.fillText("GAME OVER", w/2, h*0.32);

      ctx.font="900 26px "+fontUI;
      ctx.fillStyle="rgba(111,247,255,0.95)";
      ctx.fillText("POINTS", w/2, h*0.42);
      ctx.font="950 44px "+fontUI;
      ctx.fillStyle="rgba(255,255,255,0.96)";
      ctx.fillText(String(state.score), w/2, h*0.48);
      ctx.font="900 20px "+fontUI;
      ctx.fillStyle="rgba(255,255,255,0.85)";
      ctx.fillText("BEST "+String(state.best), w/2, h*0.54);

      var bw = Math.min(320, w*0.74), bh=64;
      var bx = (w-bw)/2, by = h*0.66;

      ctx.globalAlpha = 0.22;
      ctx.fillStyle = "#80ffd2";
      ctx.beginPath(); ctx.roundRect(bx-10, by-10, bw+20, bh+20, 24); ctx.fill();
      ctx.globalAlpha = 1;

      ctx.fillStyle="rgba(80,255,210,0.95)";
      ctx.beginPath(); ctx.roundRect(bx,by,bw,bh,22); ctx.fill();
      ctx.fillStyle="rgba(2,16,36,0.95)";
      ctx.font="950 24px "+fontUI;
      ctx.fillText("RESTART", w/2, by+bh/2+1);

      ctx.textAlign="left";
      ctx.textBaseline="alphabetic";
    }
  }

  function step(ts){
    if (!state.lastTs) state.lastTs = ts;
    state.dt = Math.min(0.033, (ts - state.lastTs)/1000);
    state.lastTs = ts;
    state.t += state.dt;

    if (state.inv>0) state.inv = Math.max(0, state.inv - state.dt);

    var kmVal = km();
    var targetSpeed = speedAt(kmVal);
    state.speed += (targetSpeed - state.speed) * (1 - Math.pow(0.001, state.dt));

    var spawnInterval = spawnIntervalAt(kmVal);

    if (state.started && !state.over){
      state.distancePx += state.speed * state.dt;

      var kmNow = Math.floor(state.distancePx / KM_PX);
      if (kmNow > state.kmCount){
        var delta = kmNow - state.kmCount;
        state.kmCount = kmNow;
        state.score += delta * POINTS_PER_KM;

        if (kmNow >= BONUS_START_KM && (kmNow % BONUS_EVERY_KM) === 0){
          state.lives += 1;
          for (var b2=0;b2<10;b2++) spawnBubble(octo.x, octo.y, rand(2,5));
        }
      }

      state.spawnTimer -= state.dt;
      var okWarmup = state.t > SAFE_START_TIME;
      var last = obstacles[obstacles.length-1];
      var minGapX = Math.max(300, state.speed * 0.95);
      var okGap = (!last) || ((W() + 140) - last.x >= minGapX);
      if (okWarmup && state.spawnTimer <= 0 && okGap){
        spawnObstacle();
        state.spawnTimer = spawnInterval + rand(-0.10, 0.22);
      }

      var ay = GRAVITY;
      if (state.holding){
        state.holdTime += state.dt;
        if (state.holdTime <= HOLD_MAX_TIME){
          var kk = clamp(0.85 + state.holdTime*1.2, 0.85, 1.20);
          ay = GRAVITY - HOLD_THRUST*kk;
          if (Math.random()<0.12) spawnBubble(octo.x-12, octo.y+10, rand(2,4));
        } else {
          ay = GRAVITY;
        }
      } else {
        state.holdTime = 0;
      }

      octo.vy += ay * state.dt;
      octo.vy = clamp(octo.vy, VY_UP_CAP, VY_DOWN_CAP);
      octo.y += octo.vy * state.dt;

      var margin = 38;
      if (octo.y < margin){ octo.y = margin; octo.vy = 140; takeHit(); }
      if (octo.y > H()-margin){ octo.y = H()-margin; octo.vy = -200; takeHit(); }

      for (var i=obstacles.length-1; i>=0; i--){
        var o = obstacles[i];
        o.x -= state.speed * state.dt;
        if (o.x + o.w < -160) obstacles.splice(i,1);
      }

      for (var j=swimmers.length-1; j>=0; j--){
        var s = swimmers[j];
        s.x -= state.speed * s.speedK * state.dt;
        if (s.x < -260) swimmers.splice(j,1);
      }
      var fishCount = 0;
      for (var fc=0; fc<swimmers.length; fc++) if (swimmers[fc].kind==='fish') fishCount++;
      if (fishCount < 10) spawnFish(false);

      for (var k2=bubbles.length-1; k2>=0; k2--){
        var b = bubbles[k2];
        b.life += state.dt;
        b.x += b.vx * state.dt;
        b.y += b.vy * state.dt;
        if (b.life > b.maxLife || b.y < -50) bubbles.splice(k2,1);
      }

      var cr = 18, cx = octo.x, cy = octo.y;
      for (var ii=0; ii<obstacles.length; ii++){
        var ob = obstacles[ii];
        var ox = ob.x, ow = ob.w;
        var topRect = {x: ox+8, y: 0, w: ow-16, h: ob.gapY-6};
        var botRect = {x: ox+8, y: ob.gapY + ob.gapH + 6, w: ow-16, h: H() - (ob.gapY + ob.gapH) - 6};
        if (circleRect(cx,cy,cr, topRect.x,topRect.y,topRect.w,topRect.h) ||
            circleRect(cx,cy,cr, botRect.x,botRect.y,botRect.w,botRect.h)){
          takeHit(); break;
        }
      }
    } else {
      octo.y = lerp(octo.y, H()*0.52, 1 - Math.pow(0.001, state.dt));
      octo.vy = 0;
    }

    drawBackground();
    for (var si=0; si<swimmers.length; si++) drawSwimmer(swimmers[si]);
    for (var oi=0; oi<obstacles.length; oi++) drawObstacle(obstacles[oi]);
    drawOcto();
    drawBubbles();
    drawHUD();

    requestAnimationFrame(step);
  }

  reset();
  requestAnimationFrame(step);

})();
</script>
</body>
</html>
